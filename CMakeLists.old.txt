cmake_minimum_required(VERSION 3.10)
project(lsqlite3 C)

# ✅ Output directory same as Lua
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY
    ${CMAKE_CURRENT_SOURCE_DIR}/../android/.cxx/Debug/2x44o286/arm64-v8a/sysroot/lib)

# ✅ Ensure all code built with -fPIC
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# ✅ Build static SQLite (with PIC)
add_library(sqlite3 STATIC sqlite3.c)
set_target_properties(sqlite3 PROPERTIES POSITION_INDEPENDENT_CODE ON)

# ✅ Enable Full Text Search + other useful features
target_compile_definitions(sqlite3 PRIVATE
  SQLITE_ENABLE_FTS3
  SQLITE_ENABLE_FTS4
  SQLITE_ENABLE_FTS5
  SQLITE_ENABLE_JSON1
  SQLITE_ENABLE_RTREE
  SQLITE_THREADSAFE=1
  SQLITE_DEFAULT_FOREIGN_KEYS=1
)

# ✅ Build shared Lua binding
add_library(lsqlite3 SHARED lsqlite3.c)

# ✅ Include directories
target_include_directories(lsqlite3 PUBLIC
  ${CMAKE_CURRENT_SOURCE_DIR}              # sqlite3.h
  ${CMAKE_CURRENT_SOURCE_DIR}/../lua       # lua headers (adjust if needed)
)

# # ✅ Add explicit linker flags to ensure symbol resolution
# target_link_options(lsqlite3 PRIVATE
#   "-Wl,--no-undefined"
#   "-Wl,--as-needed"
# )

# ✅ Create imported target for pre-built liblua.so
add_library(lua SHARED IMPORTED)
set_target_properties(lua PROPERTIES
    IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}/../lua/liblua.so
)

# ✅ Link lsqlite3 with sqlite3
target_link_libraries(lsqlite3
  ${CMAKE_SOURCE_DIR}/../lua/liblua.so  # full path to ARM64 Lua
  sqlite3
  m
  dl
)

message(STATUS "✅ Building lsqlite3 → ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}")



# export NDK_HOME=/home/cyberboy/Android/Sdk/ndk/27.1.12297006
# export TOOLCHAIN=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
# export API_LEVEL=24
# export TARGET_HOST=aarch64-linux-android

# export CC=$TOOLCHAIN/bin/$TARGET_HOST$API_LEVEL-clang
# export CXX=$TOOLCHAIN/bin/$TARGET_HOST$API_LEVEL-clang++
# export AR=$TOOLCHAIN/bin/llvm-ar
# export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
# export LD=$TOOLCHAIN/bin/ld
# export STRIP=$TOOLCHAIN/bin/llvm-strip
# export SYSROOT=$TOOLCHAIN/sysroot
# export CFLAGS="--sysroot=$SYSROOT -fPIC -D__ANDROID_API__=$API_LEVEL"
# export LDFLAGS="--sysroot=$SYSROOT"

# cmake .. \
#     -DCMAKE_TOOLCHAIN_FILE=$NDK_HOME/build/cmake/android.toolchain.cmake \
#     -DANDROID_ABI=arm64-v8a \
#     -DANDROID_PLATFORM=android-24 \
#     -DCMAKE_BUILD_TYPE=Release

# cmake --build . --config Release
